<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accueil B2B</title>
<style>
body {margin:0;font-family:Arial,sans-serif;background:#f0f2f5;}
header{position:fixed;top:0;width:100%;background:#4a76a8;color:white;padding:10px;
display:flex;justify-content:space-between;align-items:center;z-index:1000;font-size:16px;}
header .center{font-weight:bold;font-size:18px;}
header button{padding:6px 10px;border:none;border-radius:12px;margin:0 3px;background:#27ae60;color:white;cursor:pointer;font-size:14px;}
header button:hover{background:#2ecc71;}
.container{padding:10px;margin-top:60px;margin-bottom:100px;}
.cardFlyer{background:white;margin:10px 0;padding:10px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,0.2);}
.cardFlyer img,.cardFlyer video{max-width:100%;border-radius:8px;margin-top:5px;cursor:pointer;}
.commentDiv{margin-left:10px;border-left:2px solid #ccc;padding-left:5px;margin-top:5px;}
#publishArea{position:fixed;bottom:0;left:0;width:100%;background:#fff;padding:10px;
display:flex;gap:4px;align-items:center;box-shadow:0 -2px 5px rgba(0,0,0,0.1);z-index:1000;}
#publishArea input[type=text]{flex:1;padding:6px;border-radius:6px;border:1px solid #ccc;}
#publishArea button{padding:6px 10px;border-radius:6px;border:none;background:#27ae60;color:white;cursor:pointer;}
#publishArea button:hover{background:#2ecc71;}
#filePreview img,#filePreview video{max-width:80px;max-height:80px;border-radius:6px;margin-left:5px;}
.userId{color:#2980b9;cursor:pointer;font-weight:bold;}
.like-btn{color:#e74c3c;cursor:pointer;}
.like-btn:hover{color:#c0392b;}
</style>
</head>
<body>

<header>
  <div>
    <button onclick="goTo('groupes.html')">üìÇ Groupes</button>
    <button onclick="goTo('sondages.html')">üìä Sondages</button>
    <button onclick="goTo('lookme.html')">üìç LookMe</button>
    <button onclick="goTo('admin.html')">‚öôÔ∏è Admin</button>
  </div>
  <div class="center">B2B</div>
  <div id="timeInfo">‚è∞ --:--</div>
</header>

<div class="container" id="postsContainer"></div>

<div id="publishArea">
  <input type="text" id="newPostText" placeholder="√âcrire un post...">
  <button id="btnAddMedia">üìé</button>
  <button id="btnPublish">üì§ Publier</button>
</div>
<div id="filePreview" style="display:flex;align-items:center;"></div>
<input type="file" id="mediaInput" style="display:none;" accept="image/*,video/*">

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- Configuration Supabase ---
const supabaseUrl = 'https://nqqlsntgmorujffrntih.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xcWxzbnRnbW9ydWpmZnJudGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NzE5OTQsImV4cCI6MjA3NTE0Nzk5NH0.d77RSXyoK-2rFvxAiJB4xgSYpXEHsTKCdF0A3RwzXwY'
const supabase = createClient(supabaseUrl, supabaseKey)

let currentUser = 'User-' + crypto.randomUUID().slice(0,8)
let currentFile = null

// --- Horloge ---
function updateTime(){ document.getElementById('timeInfo').innerText=`‚è∞ ${new Date().toLocaleTimeString()}` }
setInterval(updateTime,1000); updateTime()

// --- Navigation ---
function goTo(page){ window.location.href = page }

// --- Chargement des posts ---
async function loadPosts(){
  const { data, error } = await supabase.from('posts').select('*').order('created_at',{ascending:false})
  if(error){ console.error(error); return }
  renderPosts(data)
}

// --- Suppression automatique apr√®s 72h ---
async function autoDeleteOldPosts(){
  const now = new Date()
  const { data } = await supabase.from('posts').select('*')
  for(let post of data){
    const created = new Date(post.created_at)
    const diff = (now - created)/(1000*60*60)
    if(diff > 72){ await supabase.from('posts').delete().eq('id', post.id) }
  }
}

// --- Rendu des posts ---
function renderPosts(posts){
  const container=document.getElementById('postsContainer')
  container.innerHTML=''
  posts.forEach(p=>{
    const card=document.createElement('div')
    card.className='cardFlyer'
    let media=''
    if(p.media_url){
      if(p.media_url.match(/\.mp4$/i)) media=`<video src="${p.media_url}" controls></video>`
      else media=`<img src="${p.media_url}">`
    }
    card.innerHTML=`
      <div><span class="userId" onclick="alert('Profil de ${p.user_id}')">${p.user_id}</span>: ${p.text}</div>
      ${media}
      <div><span class="like-btn" onclick="likePost('${p.id}')">‚ù§Ô∏è ${p.likes||0}</span></div>
      <small>${new Date(p.created_at).toLocaleString()}</small>
    `
    container.appendChild(card)
  })
}

// --- Ajout m√©dia ---
document.getElementById('btnAddMedia').onclick=()=>document.getElementById('mediaInput').click()
document.getElementById('mediaInput').onchange=(e)=>{
  const file=e.target.files[0]; if(!file)return;
  currentFile=file
  const preview=document.getElementById('filePreview')
  preview.innerHTML=''
  const url=URL.createObjectURL(file)
  if(file.type.startsWith('image/')) preview.innerHTML=`<img src="${url}" style="max-width:100px;">`
  else preview.innerHTML=`<video src="${url}" controls style="max-width:100px;"></video>`
}

// --- Publier ---
document.getElementById('btnPublish').onclick=async()=>{
  const text=document.getElementById('newPostText').value.trim()
  if(!text && !currentFile) return alert('√âcris quelque chose ou ajoute un fichier !')

  let mediaUrl=null
  if(currentFile){
    const name=`${Date.now()}_${currentFile.name}`
    const { error:uploadError }=await supabase.storage.from('media').upload(name,currentFile)
    if(uploadError){ console.error(uploadError);alert('Erreur upload m√©dia');return }
    const { data:urlData }=supabase.storage.from('media').getPublicUrl(name)
    mediaUrl=urlData.publicUrl
  }

  const { error:insertError }=await supabase.from('posts').insert([{user_id:currentUser,text,media_url:mediaUrl,likes:0}])
  if(insertError){ console.error(insertError);alert('Erreur cr√©ation post');return }

  document.getElementById('newPostText').value=''
  document.getElementById('filePreview').innerHTML=''
  currentFile=null
  loadPosts()
}

// --- Like ---
async function likePost(id){
  const { data } = await supabase.from('posts').select('likes').eq('id',id).single()
  const newLikes=(data.likes||0)+1
  await supabase.from('posts').update({likes:newLikes}).eq('id',id)
  loadPosts()
}

window.likePost=likePost

autoDeleteOldPosts()
loadPosts()
</script>
</body>
</html>