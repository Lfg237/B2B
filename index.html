<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accueil B2B</title>
<style>
body {margin:0;font-family:Arial,sans-serif;background:#f0f2f5;}
header{position:fixed;top:0;width:100%;background:#4a76a8;color:white;padding:10px;display:flex;justify-content:space-between;align-items:center;z-index:1000;font-size:16px;}
header .center{font-weight:bold;font-size:18px;}
header button{padding:6px 10px;border:none;border-radius:12px;margin:0 3px;background:#27ae60;color:white;cursor:pointer;font-size:14px;}
header button:hover{background:#2ecc71;}
.container{padding:10px;margin-top:60px;margin-bottom:100px;}
.cardFlyer{background:white;margin:10px 0;padding:10px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,0.2);}
.cardFlyer img, .cardFlyer video{max-width:100%;border-radius:8px;margin-top:5px;cursor:pointer;}
.commentDiv{margin-left:10px;border-left:2px solid #ccc;padding-left:5px;margin-top:5px;}
#publishArea{position:fixed;bottom:0;left:0;width:100%;background:#fff;padding:10px;display:flex;gap:4px;align-items:center;box-shadow:0 -2px 5px rgba(0,0,0,0.1);z-index:1000;}
#publishArea input[type=text]{flex:1;padding:6px;border-radius:6px;border:1px solid #ccc;}
#publishArea button{padding:6px 10px;border-radius:6px;border:none;background:#27ae60;color:white;cursor:pointer;}
#publishArea button:hover{background:#2ecc71;}
#filePreview img,#filePreview video{max-width:80px;max-height:80px;border-radius:6px;margin-left:5px;}
.userId{color:#2980b9;cursor:pointer;font-weight:bold;}
</style>
</head>
<body>

<header>
  <div>
    <button onclick="goTo('groupes.html')">üìÇ Groupes</button>
    <button onclick="goTo('sondages.html')">üìä Sondages</button>
    <button onclick="goTo('lookme.html')">üìç LookMe</button>
    <button onclick="goTo('admin.html')">‚öôÔ∏è Admin</button>
  </div>
  <div class="center">B2B</div>
  <div id="timeInfo">‚è∞ --:--</div>
</header>

<div class="container" id="postsContainer"></div>

<div id="publishArea">
  <input type="text" id="newPostText" placeholder="√âcrire un post...">
  <button id="btnAddMedia">üìé</button>
  <button id="btnPublish">üì§ Publier</button>
</div>
<div id="filePreview" style="display:flex;align-items:center;"></div>
<input type="file" id="mediaInput" style="display:none;" accept="image/*,video/*">

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// --- CONNEXION SUPABASE ---
const supabaseUrl = 'https://nqqlsntgmorujffrntih.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xcWxzbnRnbW9ydGpmZnJudGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NzE5OTQsImV4cCI6MjA3NTE0Nzk5NH0.d77RSXyoK-2rFvxAiJB4xgSYpXEHsTKCdF0A3RwzXwY';
const supabase = createClient(supabaseUrl, supabaseKey);

// --- UTILISATEUR ANONYME ---
let currentUser = 'User'+Math.floor(Math.random()*1000);

// --- CHARGEMENT DES POSTS EXISTANTS ---
let postsList = [];

async function loadPosts() {
  const { data, error } = await supabase.from('posts').select('*').order('created_at', {ascending:true});
  if(error) { console.error(error); return; }
  postsList = data;
  renderPosts();
}

// --- MISE √Ä JOUR DE L'HEURE ---
function updateTime() {
  document.getElementById('timeInfo').innerText = `‚è∞ ${new Date().toLocaleTimeString()}`;
}
setInterval(updateTime,1000);
updateTime();

// --- AJOUT MEDIA ---
let currentFile = null;
document.getElementById('btnAddMedia').onclick = ()=> document.getElementById('mediaInput').click();
document.getElementById('mediaInput').onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  currentFile = file;
}

// --- PUBLIER UN POST ---
document.getElementById('btnPublish').onclick = async ()=>{
  const text = document.getElementById('newPostText').value.trim();
  if(!text && !currentFile) return alert('√âcris quelque chose ou ajoute un fichier !');

  let mediaUrl = null;
  if(currentFile){
    const fileExt = currentFile.name.split('.').pop();
    const fileName = `${Math.random()}.${fileExt}`;
    const { data, error } = await supabase.storage.from('media').upload(fileName, currentFile);
    if(error) { console.error(error); alert('Erreur upload fichier'); return; }
    mediaUrl = supabase.storage.from('media').getPublicUrl(fileName).publicURL;
  }

  const { data, error } = await supabase.from('posts').insert([
    { user_id: currentUser, text: text, media_url: mediaUrl }
  ]);
  if(error) { console.error(error); return; }
  document.getElementById('newPostText').value='';
  currentFile=null;
  renderPosts();
}

// --- AFFICHAGE DES POSTS ---
function renderPosts(){
  const container = document.getElementById('postsContainer');
  container.innerHTML='';
  postsList.forEach((post,i)=>{
    const card = document.createElement('div');
    card.className='cardFlyer';
    let mediaHTML='';
    if(post.media_url){
      if(post.media_url.match(/\.(jpeg|jpg|png|gif)$/i)) mediaHTML = `<img src="${post.media_url}"><br>`;
      else mediaHTML = `<video src="${post.media_url}" controls></video><br>`;
    }
    const userHTML = `<span class="userId" onclick="privateChat('${post.user_id}')">${post.user_id}</span>`;
    card.innerHTML = `<div><b>${userHTML}</b>: ${post.text}<br>${mediaHTML}</div>`;

    // Like
    const btnLike = document.createElement('button');
    btnLike.innerText='‚ù§Ô∏è Like';
    btnLike.onclick = () => alert('Like √† impl√©menter avec Supabase');
    card.appendChild(btnLike);

    // Commenter
    const btnComment = document.createElement('button');
    btnComment.innerText='üí¨ Commenter';
    btnComment.onclick = () => alert('Commentaires √† impl√©menter');
    card.appendChild(btnComment);

    container.appendChild(card);
  });
}

// --- CONVERSATION PRIV√âE ---
function privateChat(userId){
  alert(`Invitation √† discuter en priv√© avec ${userId}`);
}

// --- NAVIGATION ---
function goTo(page){ window.location.href = page; }

loadPosts();
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Initialisation Supabase
const SUPABASE_URL = "https://nqqlsntgmorujffrntih.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xcWxzbnRnbW9ydGpmZnJudGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NzE5OTQsImV4cCI6MjA3NTE0Nzk5NH0.d77RSXyoK-2rFvxAiJB4xgSYpXEHsTKCdF0A3RwzXwY";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Pseudo utilisateur anonyme
let currentUser = "User" + Math.floor(Math.random()*1000);

// R√©cup√©rer les posts depuis Supabase
async function fetchPosts(){
    const { data, error } = await supabase
        .from('posts')
        .select('*')
        .order('created_at', { ascending: false });
    if(error){ console.error(error); return; }
    renderPosts(data);
}

// Publier un post
document.getElementById('btnPublish').onclick = async () => {
    const text = document.getElementById('newPostText').value.trim();
    if(!text && !currentFile) return alert("√âcris quelque chose ou ajoute un fichier !");
    
    let media_url = null;
    if(currentFile){
        const fileExt = currentFile.name.split('.').pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const { data, error } = await supabase.storage
            .from('media')
            .upload(fileName, currentFile);
        if(error){ console.error(error); alert("Erreur upload m√©dia"); return; }
        media_url = supabase.storage.from('media').getPublicUrl(fileName).data.publicUrl;
    }

    const { data, error } = await supabase
        .from('posts')
        .insert([{ user: currentUser, text, media: media_url }]);
    if(error){ console.error(error); alert("Erreur cr√©ation post"); return; }

    document.getElementById('newPostText').value = '';
    currentFile = null;
    document.getElementById('filePreview').innerHTML = '';
    fetchPosts();
}

// Pr√©visualisation m√©dia
document.getElementById('btnAddMedia').onclick = ()=> document.getElementById('mediaInput').click();
document.getElementById('mediaInput').onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    currentFile = file;
    const url = URL.createObjectURL(file);
    const previewDiv = document.getElementById('filePreview');
    previewDiv.innerHTML = file.type.startsWith('image/') ? `<img src="${url}">` : `<video src="${url}" controls></video>`;
}

// Afficher les posts avec likes et commentaires
async function renderPosts(posts){
    const container = document.getElementById('postsContainer');
    container.innerHTML = '';
    for(const post of posts){
        const card = document.createElement('div');
        card.className = 'cardFlyer';
        let mediaHTML = post.media ? (post.media.includes('.mp4') ? `<video src="${post.media}" controls></video>` : `<img src="${post.media}">`) : '';
        card.innerHTML = `<div><b>${post.user}</b>: ${post.text}<br>${mediaHTML}<br>Likes: <span id="likes${post.id}">${post.likes||0}</span></div>`;
        
        // Like
        const btnLike = document.createElement('button');
        btnLike.innerText='‚ù§Ô∏è Like';
        btnLike.onclick=async ()=>{
            if(post.likedUsers?.includes(currentUser)) return alert("Vous avez d√©j√† lik√© ce post !");
            const { data, error } = await supabase.from('posts').update({
                likes: (post.likes||0)+1,
                likedUsers: [...(post.likedUsers||[]), currentUser]
            }).eq('id', post.id);
            if(error) return console.error(error);
            fetchPosts();
        }
        card.appendChild(btnLike);

        // Commentaire
        const btnComment = document.createElement('button');
        btnComment.innerText='üí¨ Commenter';
        btnComment.onclick=async ()=>{
            const textC = prompt("Votre commentaire :");
            if(!textC) return;
            const newComments = [...(post.comments||[]), { user: currentUser, text:textC, subcomments:[] }];
            await supabase.from('posts').update({ comments: newComments }).eq('id', post.id);
            fetchPosts();
        }
        card.appendChild(btnComment);

        // Supprimer post si auteur
        if(post.user === currentUser){
            const btnDelete = document.createElement('button');
            btnDelete.innerText='üóë Supprimer';
            btnDelete.onclick=async ()=>{
                if(confirm("Supprimer ce post ?")){
                    await supabase.from('posts').delete().eq('id', post.id);
                    fetchPosts();
                }
            }
            card.appendChild(btnDelete);
        }

        // Commentaires imbriqu√©s
        if(post.comments?.length){
            const commentsDiv = document.createElement('div');
            for(const c of post.comments){
                const cDiv = document.createElement('div');
                cDiv.className='commentDiv';
                cDiv.innerHTML=`<b>${c.user}</b>: ${c.text}`;
                if(c.subcomments?.length){
                    for(const sc of c.subcomments){
                        const scDiv = document.createElement('div');
                        scDiv.className='commentDiv';
                        scDiv.innerHTML=`<b>${sc.user}</b>: ${sc.text}`;
                        cDiv.appendChild(scDiv);
                    }
                }
                commentsDiv.appendChild(cDiv);
            }
            card.appendChild(commentsDiv);
        }

        container.appendChild(card);
    }
}

// Conversation priv√©e
function privateChat(userId){
    alert(`Discussion priv√©e avec ${userId} (√† d√©velopper)`);
}

// Navigation
function goTo(page){ window.location.href = page; }

// Initial fetch
fetchPosts();
</script>
</script>
</body>
</html>