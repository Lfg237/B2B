<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Espace LesFacilitateurs</title>
<style>
body {
  background-color: #0a0f1a;
  color: #e0e6ff;
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 10px;
}
h1 {
  text-align: center;
  color: #4ea1ff;
}
.cardFlyer {
  background: #121b2c;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}
.cardFlyer img, .cardFlyer video {
  max-width: 100%;
  border-radius: 10px;
  margin-top: 8px;
}
button {
  background: #0044cc;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
}
button:hover {
  background: #0059ff;
}
.like-btn {
  cursor: pointer;
  color: #ff4d6d;
  font-weight: bold;
}
#publishArea {
  display: none;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 15px;
  background: #11192a;
  padding: 10px;
  border-radius: 12px;
}
#filePreview img, #filePreview video {
  max-width: 100%;
  border-radius: 8px;
  margin-top: 8px;
}
input, textarea {
  width: 100%;
  background: #0f1626;
  color: white;
  border: 1px solid #2a3b57;
  border-radius: 8px;
  padding: 8px;
}
#adminCodeArea {
  background: #11192a;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 15px;
}
.post-link {
  color: #00aaff;
  text-decoration: underline;
  cursor: pointer;
}
</style>
</head>
<body>
<h1>LesFacilitateurs</h1>
<!-- Compteur et liste des abonn√©s -->
<div id="subscribersBar" style="margin: 12px 0; position: relative;">
  <button id="toggleSubscribers">Abonn√©s: 0 ‚¨áÔ∏è</button>
  <div id="subscribersList" style="display:none; 
      position: absolute; background:#11192a; 
      max-height:200px; overflow-y:auto; width:200px; border-radius:8px; padding:8px; z-index:10;">
    <!-- Liste des abonn√©s charg√©e ici -->
  </div>
</div>
<!-- Zone d'acc√®s admin -->
<div id="adminCodeArea">
  <label>üîê Entrer le code administrateur :</label>
  <input type="password" id="adminCodeInput" placeholder="Code admin...">
  <button onclick="checkAdminCode()">Valider</button>
</div>

<!-- Zone publication -->
<div id="publishArea">
  <textarea id="newPostText" placeholder="√âcrire un post..."></textarea>
  <div id="filePreview"></div>
  <input type="file" id="mediaInput" accept="image/*,video/*" hidden>
  <button id="btnAddMedia">+ Ajouter m√©dia</button>
  <button id="btnPublish">Publier</button>
</div>

<!-- Liste des posts -->
<div id="postsContainer"></div>

<!-- Barre de boutons horizontale pour liens externes -->
<div id="externalLinksBar" style="display:flex; overflow-x:auto; gap:8px; padding:8px; background:#1c1f2b; color:white;">
  <button class="link-btn" data-url="https://lovestring.vercel.app/">rencontre  c√©libataire</button>
  <button class="link-btn" data-url="https://facebook.com">‚ùå</button>
  <button class="link-btn" data-url="https://lesfacilitateurs.cm">‚ùå</button>
  <button class="link-btn" data-url="https://example.com">‚ùå</button>
  <button class="link-btn" data-url="https://example.com">‚ùå</button>
</div>

<!-- Iframe pour afficher les liens -->
<div id="linkViewer" style="width:100%; height:400px; display:none; border:none;">
  <iframe id="iframeViewer" style="width:100%; height:100%; border:none;"></iframe>
</div>

<script>
  const buttons = document.querySelectorAll('.link-btn');
  const iframeViewer = document.getElementById('iframeViewer');
  const linkViewer = document.getElementById('linkViewer');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const url = btn.dataset.url;
      iframeViewer.src = url;
      linkViewer.style.display = 'block';
    });
  });

  // Gestion des liens dans les posts
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('post-link')) {
      e.preventDefault();
      const url = e.target.dataset.url;
      iframeViewer.src = url;
      linkViewer.style.display = 'block';
    }
  });
</script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://nqqlsntgmorujffrntih.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xcWxzbnRnbW9ydWpmZnJudGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NzE5OTQsImV4cCI6MjA3NTE0Nzk5NH0.d77RSXyoK-2rFvxAiJB4xgSYpXEHsTKCdF0A3RwzXwY'
const supabase = createClient(supabaseUrl, supabaseKey)

let currentUser = 'User-' + crypto.randomUUID().slice(0,8)
let currentFile = null
let isAdmin = false

const adminCodeInput = document.getElementById('adminCodeInput')
const postsContainer = document.getElementById('postsContainer')
const publishArea = document.getElementById('publishArea')
const adminCodeArea = document.getElementById('adminCodeArea')
const filePreview = document.getElementById('filePreview')

// Masquer zone publication au d√©part
publishArea.style.display = 'none'

// V√©rification code admin
window.checkAdminCode = function() {
  const code = adminCodeInput.value.trim()
  if (code === '233233') {
    isAdmin = true
    alert('‚úÖ Acc√®s administrateur activ√© !')
    adminCodeArea.style.display = 'none'
    publishArea.style.display = 'flex'
    loadPosts()
  } else {
    alert('‚ùå Code incorrect, acc√®s refus√©')
  }
}

// Gestion m√©dia
document.getElementById('btnAddMedia').onclick = () => document.getElementById('mediaInput').click()
document.getElementById('mediaInput').onchange = e => {
  currentFile = e.target.files[0]
  if (!currentFile) return
  const url = URL.createObjectURL(currentFile)
  filePreview.innerHTML = currentFile.type.startsWith('image/')
    ? `<img src="${url}">`
    : `<video src="${url}" controls></video>`
}

// Publier post (admin seulement)
document.getElementById('btnPublish').onclick = async () => {
  if (!isAdmin) return alert('Seul l‚Äôadministrateur peut publier.')
  const text = document.getElementById('newPostText').value.trim()
  if (!text && !currentFile) return alert('Rien √† publier.')

  let mediaUrl = null
  if (currentFile) {
    const fileName = `${Date.now()}_${currentFile.name}`
    const { error: uploadError } = await supabase.storage.from('media').upload(fileName, currentFile)
    if (uploadError) return alert('Erreur upload m√©dia.')
    const { data: urlData } = supabase.storage.from('media').getPublicUrl(fileName)
    mediaUrl = urlData.publicUrl
  }

  const { error } = await supabase.from('posts').insert([{
    id: crypto.randomUUID(),
    user_id: currentUser,
    text,
    media_url: mediaUrl,
    likes: 0,
    liked_by: [],
    created_at: new Date().toISOString()
  }])
  if (error) return alert('Erreur cr√©ation post.')

  document.getElementById('newPostText').value = ''
  filePreview.innerHTML = ''
  currentFile = null
  loadPosts()
}

// Charger posts
async function loadPosts() {
  postsContainer.innerHTML = ''
  const { data: posts } = await supabase.from('posts').select().order('created_at', { ascending: false })
  posts.forEach(post => {
    const media = post.media_url ? (post.media_url.endsWith('.mp4')
      ? `<video src="${post.media_url}" controls></video>`
      : `<img src="${post.media_url}">`) : ''
    const card = document.createElement('div')
    card.className = 'cardFlyer'
    card.innerHTML = `
      <b>${post.user_id}</b>: ${formatPostText(post.text)}<br>
      ${media}
      <div style="margin-top:6px;">
        <span class="like-btn" onclick="likePost('${post.id}')">‚ù§Ô∏è ${post.likes || 0}</span>
        ${isAdmin ? `<button onclick="deletePost('${post.id}')">üóëÔ∏è</button>` : ''}
      </div>
      <small>${new Date(post.created_at).toLocaleString()}</small>
    `
    postsContainer.appendChild(card)
  })
}

// Transformation du texte en HTML cliquable
function formatPostText(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, '<a href="#" class="post-link" data-url="$1">$1</a>');
}

// Like
window.likePost = async (id) => {
  const { data: post } = await supabase.from('posts').select('likes, liked_by').eq('id', id).single()
  if (!post) return
  if (post.liked_by?.includes(currentUser)) return alert('D√©j√† lik√© !')

  const newLikes = (post.likes || 0) + 1
  const newLikedBy = [...(post.liked_by || []), currentUser]
  await supabase.from('posts').update({ likes: newLikes, liked_by: newLikedBy }).eq('id', id)
  loadPosts()
}
// --- Abonnement en temps r√©el pour les likes ---
supabase
  .channel('public:posts')
  .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'posts' }, payload => {
    const updatedPost = payload.new
    const likeSpan = document.querySelector(`.like-btn[onclick="likePost('${updatedPost.id}')"]`)
    if (likeSpan) likeSpan.textContent = `‚ù§Ô∏è ${updatedPost.likes || 0}`
  })
  .subscribe()
// Supprimer post (admin)
window.deletePost = async (id) => {
  if (!isAdmin) return alert('Seul l‚Äôadministrateur peut supprimer.')
  await supabase.from('posts').delete().eq('id', id)
  loadPosts()
}

loadPosts()
const toggleBtn = document.getElementById('toggleSubscribers');
const subscribersList = document.getElementById('subscribersList');

async function loadSubscribers() {
  const { data: users, error } = await supabase.from('utilisateurs').select('id');
  if (error) return console.error(error);
  
  subscribersList.innerHTML = '';
  users.forEach(u => {
    const div = document.createElement('div');
    div.textContent = u.id;
    subscribersList.appendChild(div);
  });
  
  toggleBtn.textContent = `Abonn√©s: ${users.length} ‚¨áÔ∏è`;
}

// Toggle affichage
toggleBtn.addEventListener('click', () => {
  subscribersList.style.display = subscribersList.style.display === 'none' ? 'block' : 'none';
});

// Charger au d√©part
loadSubscribers();
</script>
</body>
</html>