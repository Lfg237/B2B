<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Accueil B2B</title>
<style>
body {margin:0;font-family:Arial,sans-serif;background:#f0f2f5;}
header {display:flex; flex-direction:column; align-items:center; padding:15px 10px; background:#4a76a8; color:white;}
header .icon-group {display:flex; justify-content:center; gap:20px; margin-bottom:8px;}
header .icon-group div {text-align:center; cursor:pointer;}
header .icon-group div span {font-size:20px;}
header .center {font-weight:bold;font-size:22px; margin-bottom:8px;}
#searchBar {width:100%; display:flex; justify-content:center; margin-bottom:5px;}
#searchBar input[type=text] {width:60%; padding:6px; border-radius:6px; border:1px solid #ccc;}
#searchBar button {padding:6px 10px; margin-left:5px; border:none; border-radius:6px; background:#27ae60; color:white; cursor:pointer;}
.container {padding:10px; margin-top:10px; margin-bottom:120px;}
.cardFlyer {background:white; margin:10px 0; padding:10px; border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,0.2);}
.cardFlyer img,.cardFlyer video{max-width:100%;border-radius:8px;margin-top:5px;cursor:pointer;}
.userId{color:#2980b9; cursor:pointer; font-weight:bold;}
.like-btn{color:#e74c3c; cursor:pointer;}
.like-btn:hover{color:#c0392b;}
#publishArea{position:fixed;bottom:0;left:0;width:100%;background:#fff;padding:10px;display:flex;gap:4px;align-items:center;box-shadow:0 -2px 5px rgba(0,0,0,0.1);}
#publishArea input[type=text]{flex:1;padding:6px;border-radius:6px;border:1px solid #ccc;}
#publishArea button{padding:6px 10px;border-radius:6px;border:none;background:#27ae60;color:white;cursor:pointer;}
#publishArea button:hover{background:#2ecc71;}
#filePreview img,#filePreview video{max-width:80px;max-height:80px;border-radius:6px;margin-left:5px;}
</style>
</head>
<body>

<header>
  <div class="icon-group">
    <div onclick="goTo('groupes.html')"><span>üë•</span><br>Groupes</div>
    <div onclick="goTo('sondages.html')"><span>‚öñÔ∏è</span><br>Sondages</div>
    <div onclick="goTo('lookme.html')"><span>üëÅÔ∏è</span><br>LookMe</div>
    <div onclick="goTo('admin.html')"><span>‚öôÔ∏è</span><br>Admin</div>
  </div>
  <div class="center">B2B</div>
  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Rechercher...">
    <button onclick="doSearch()">‚û°Ô∏è</button>
  </div>
  <div id="timeInfo">‚è∞ --:--</div>
</header>

<div class="container" id="postsContainer"></div>

<div id="publishArea">
  <input type="text" id="newPostText" placeholder="√âcrire un post...">
  <button id="btnAddMedia">üìé</button>
  <button id="btnPublish">üì§ Publier</button>
</div>
<div id="filePreview" style="display:flex;align-items:center;"></div>
<input type="file" id="mediaInput" style="display:none;" accept="image/*,video/*">

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://nqqlsntgmorujffrntih.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xcWxzbnRnbW9ydWpmZnJudGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NzE5OTQsImV4cCI6MjA3NTE0Nzk5NH0.d77RSXyoK-2rFvxAiJB4xgSYpXEHsTKCdF0A3RwzXwY'
const supabase = createClient(supabaseUrl, supabaseKey)

let currentUser = 'User-' + crypto.randomUUID().slice(0,8)
let currentFile = null

// Horloge
function updateTime(){ document.getElementById('timeInfo').innerText=`‚è∞ ${new Date().toLocaleTimeString()}` }
setInterval(updateTime,1000); updateTime()

function goTo(page){ window.location.href = page }

// --- Recherche ---
window.doSearch = async function(){
  const term = document.getElementById('searchInput').value.trim().toLowerCase()
  const { data: posts, error } = await supabase.from('posts').select('*').order('created_at',{ascending:true})
  if(error){ console.error(error); return }
  const filtered = posts.filter(p=>p.text.toLowerCase().includes(term) || p.user_id.toLowerCase().includes(term))
  renderPosts(filtered)
}

// --- Chargement des posts ---
async function loadPosts(){
  const { data: posts, error } = await supabase.from('posts').select('*').order('created_at',{ascending:true})
  if(error){ console.error(error); return }
  renderPosts(posts)
}

// --- Render posts ---
function renderPosts(posts){
  const container = document.getElementById('postsContainer')
  container.innerHTML = ''
  posts.forEach(post=>{
    const card = document.createElement('div')
    card.className = 'cardFlyer'

    let media = ''
    if(post.media_url){
      if(post.media_url.match(/\.mp4$/i)) media=`<video src="${post.media_url}" controls></video>`
      else media=`<img src="${post.media_url}">`
    }

    card.innerHTML = `
      <div>
        <span class="userId">${post.user_id}</span>: ${post.text}
        ${media}
        <div><span class="like-btn" onclick="likePost('${post.id}')">‚ù§Ô∏è ${post.likes||0}</span></div>
        <small>${new Date(post.created_at).toLocaleString()}</small>
      </div>
    `
    container.appendChild(card)
  })
}

// --- Like post ---
window.likePost = async function(postId){
  try {
    const { data, error } = await supabase.from('posts').select('likes').eq('id', postId).single()
    if(error){ console.error(error); return }
    const newLikes = (data.likes||0)+1
    const { error:updateError } = await supabase.from('posts').update({likes:newLikes}).eq('id',postId)
    if(updateError){ console.error(updateError); return }
    const likeSpan = document.querySelector(`.like-btn[onclick="likePost('${postId}')"]`)
    if(likeSpan) likeSpan.textContent = `‚ù§Ô∏è ${newLikes}`
  } catch(err){ console.error(err) }
}

// --- Gestion des fichiers m√©dia ---
document.getElementById('btnAddMedia').onclick = ()=> document.getElementById('mediaInput').click()
document.getElementById('mediaInput').onchange = e=>{
  currentFile = e.target.files[0]
  if(!currentFile) return
  const url = URL.createObjectURL(currentFile)
  const preview = document.getElementById('filePreview')
  preview.innerHTML = currentFile.type.startsWith('image/') 
    ? `<img src="${url}" style="max-width:100px; max-height:100px; border-radius:6px;">`
    : `<video src="${url}" controls style="max-width:100px; max-height:100px; border-radius:6px;"></video>`
}

// --- Publier post ---
document.getElementById('btnPublish').onclick = async ()=>{
  const text = document.getElementById('newPostText').value.trim()
  if(!text && !currentFile) return alert('√âcris quelque chose ou ajoute un fichier !')

  let mediaUrl = null
  if(currentFile){
    const name = `${Date.now()}_${currentFile.name}`
    const { error:uploadError } = await supabase.storage.from('media').upload(name,currentFile)
    if(uploadError){ console.error(uploadError); alert('Erreur upload m√©dia'); return }
    const { data: urlData } = supabase.storage.from('media').getPublicUrl(name)
    mediaUrl = urlData.publicUrl
  }

  const { error } = await supabase.from('posts').insert([{
    id: crypto.randomUUID(),
    user_id: currentUser,
    text,
    media_url: mediaUrl,
    likes: 0,
    created_at: new Date()
  }])
  if(error){ console.error(error); alert('Erreur cr√©ation post'); return }

  document.getElementById('newPostText').value=''
  document.getElementById('filePreview').innerHTML=''
  currentFile = null
  loadPosts()
}

// --- Chargement initial ---
loadPosts()
</script>
</body>
</html>